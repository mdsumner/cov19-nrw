---
title: "COV19 in North Rhein-Westphalia"
output:
  rmarkdown::html_document:
      code_folding: hide
---

```{r opts, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = TRUE,
  message = TRUE,
  comment = "#>",
  width = "100%",
  fig.path = "docs/"
)
```

This is all just a direct translation of the analyses of [Tim
Churches](https://timchurches.github.io), primarily from [this blog
post](https://timchurches.github.io/blog/posts/2020-02-18-analysing-covid-19-2019-ncov-outbreak-data-with-r-part-1).
See also [part 2 of that blog
post](https://timchurches.github.io/blog/posts/2020-03-01-analysing-covid-19-2019-ncov-outbreak-data-with-r-part-2/),
and a higher-level description on the [RStudio Community
Blog](https://rviews.rstudio.com/2020/03/05/covid-19-epidemiology-with-r). All
gratitude and credit to Tim Churches.

```{r libraries, message = FALSE}
library (lubridate)
library (tidyr)
library (ggplot2)
theme_set (theme_light ())
library (dplyr)
# Specific libraries for epidemic analyses:
library (incidence)
library (epitrix)
library (distcrete)
library (EpiEstim)
```


The raw data in this case are from the wikipedia site for
[2020_coronavirus_outbreak_in_Germany](https://en.wikipedia.org/wiki/2020_coronavirus_outbreak_in_Germany),
which contains the most up-to-date information, archived daily from the
"official" figures from the Robert Koch Institute (RKI). Note that RKI did not
update counts for NRW for the 11th or 12th of March, and that intermediate,
alternative figures exceeded the figure eventually given on the 13th of March.
The drop on that date is thus a statistical artefact, not a real drop in cases.
This site will be updated daily, at least until things are clearly under
control (last update `r today()`). The raw data as presented in wikipedia are
presented here, noting that the figures for NRW were no released for 10-11th
March, and by the time they release updated figures on the 13th, that figure
was lower that the state's official figure for the 12th. The value for the 12th
(of 688) has been adjusted to the official Robert Koch Institute figure for the
13th of 801.

```{r raw-data}
# official NRW figures go 648, 801, 688, 936 - manually adjusted to 648, 801, 80, 936
x <- rbind (c ("Baden-WÃ¼rttemberg", 0, 1, 3, 6, 10, 14, 15, 19, 26, 44, 65, 91, 116, 182, 199, 237, 277, 454, 454, 569, 827, 1105, 1479, 1609, 2155, 2746),
            c ("Bavaria", 14, 14, 14, 14, 15, 15, 19, 25, 35, 48, 52, 79, 117, 148, 256, 314, 366, 500, 588, 681, 886, 1067, 1109, 1243, 1592, 2401),
            c ("Berlin", 0, 0, 0, 0, 0, 0, 0, 1, 3, 6, 9, 15, 24, 28, 40, 48, 90, 137, 174, 216, 283, 300, 345, 391, 573, 731),
            c ("Brandenburg", 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 2, 2, 2, 6, 9, 24, 30, 44, 61, 84, 94, 73, 92, 134, 192),
            c ("Bremen", 0, 0, 0, 0, 0, 0, 1, 1, 1, 2, 3, 4, 4, 4, 4, 4, 21, 38, 42, 50, 53, 56, 57, 69, 80, 121),
            c ("Hamburg", 0, 0, 0, 0, 0, 0, 1, 1, 2, 2, 8, 8, 12, 13, 17, 29, 48, 88, 99, 158, 162, 260, 310, 358, 432, 586),
            c ("Hessen", 0, 0, 0, 0, 0, 3, 8, 10, 10, 12, 14, 15, 16, 17, 20, 35, 48, 99, 148, 203, 286, 342, 373, 432, 682, 813),
            c ("Mecklenburg-Vorpommern", 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 4, 5, 5, 7, 8, 13, 17, 23, 33, 45, 50, 51, 45, 56, 98, 131),
            c ("Lower Saxony", 0, 0, 0, 0, 0, 0, 1, 1, 1, 4, 10, 18, 19, 21, 33, 49, 75, 129, 230, 253, 287, 391, 325, 478, 699, 803),
            c ("North Rhine-Westphalia", 0, 1, 2, 4, 25, 30, 66, 86, 101, 111, 175, 281, 346, 392, 484, 648, 801, 801, 936, 1154, 1407, 1541, 2105, 2372, 3033, 3497),
            c ("Rhineland-Palatinate", 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 7, 8, 10, 15, 19, 25, 25, 52, 102, 121, 168, 325, 442, 474, 637, 801),
            c ("Saarland", 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 2, 4, 5, 7, 14, 14, 40, 40, 32, 85, 75, 88, 99, 146),
            c ("Saxony", 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 4, 10, 22, 26, 45, 83, 93, 130, 140, 182, 198, 275, 394),
            c ("Saxony-Anhalt", 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 15, 27, 42, 45, 47, 77, 55, 105, 140, 180),
            c ("Schleswig-Holstein", 0, 0, 0, 0, 1, 1, 2, 2, 2, 2, 3, 7, 8, 8, 9, 9, 27, 31, 48, 60, 103, 123, 127, 159, 202, 266),
            c ("Thuringia", 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 2, 2, 4, 10, 14, 29, 4, 51, 55, 51, 74, 98, 149))
state <- x [, 1]
x <- data.frame (apply (x [, 2:ncol (x)], 2, function (i) as.integer (i)))
ndays <- ncol (x)
names (x) <- paste0 (ymd ("2020-02-24") + days (seq (ndays) - 1))
x <- cbind (state = state, x)
```

Current trajectories for each state of Germany look like this:

```{r germany-plot, message = FALSE}
xl <- pivot_longer (x, col = names (x) [-1])
xl$name <- ymd (xl$name)
xl <- rename (xl, date = name, cases = value)
ggplot (xl, aes (x = date, y = cases, colour = state)) +
    geom_line () +
    geom_point ()
```

Tim's functions for fitting the main "SIR" (Susceptible, Infectious, Recovered)
model are as follows.

```{r main-model}
SIR <- function(time, state, parameters) {
    par <- as.list(c(state, parameters))
    with(par, {
             dS <- -beta * I * S/N
             dI <- beta * I * S/N - gamma * I
             dR <- gamma * I
             list(c(dS, dI, dR))
            })
}

# put the daily cumulative incidence numbers into a vector called Infected
this_state <- "North Rhine-Westphalia"
sir_start_date <- min (xl$date)
sir_latest_date <- max (xl$date)
Infected <- as.integer (x [x$state == this_state, 2:ncol (x)])
# Heinsberg data only (values#9, 12 are interpolated)
#Infected <- c (1, 2, 16, 37, 60, 68, 79, 84, 135, 195, 220, 250, 277)
index <- min (which (Infected > 0)):length (Infected)
dates <- sir_start_date + days ((1:ndays - 1) [index])
Infected <- Infected [index]
Day <- seq_along (Infected)

# now specify initial values for S, I and R
N <- 17.9e6 # current wikipedia population of NRW
#N <- 41946 # Heinsberg
init <- c(S = N - Infected[1], I = Infected[1], R = 0)

# define a function to calculate the residual sum of squares
# (RSS), passing in parameters beta and gamma that are to be
# optimised for the best fit to the incidence data
RSS <- function(parameters) {
    names(parameters) <- c("beta", "gamma")
    out <- deSolve::ode (y = init, times = Day, func = SIR, parms = parameters)
    fit <- out [, 3]
    sum ((Infected - fit) ^ 2)
}

# now find the values of beta and gamma that give the
# smallest RSS, which represents the best fit to the data.
# Start with values of 0.5 for each, and constrain them to
# the interval 0 to 1.0
Opt <- optim (c (0.5, 0.5), RSS, method = "L-BFGS-B",
              lower = c(0, 0), upper = c(1, 1))

# check for convergence
Opt$message

Opt_par <- setNames(Opt$par, c("beta", "gamma"))
Opt_par
```
Those parameters are used to determine the basic reproductive rate of the
virus.

```{r R0-estimate}
# get the fitted values from our SIR model
fitted_cumulative_incidence <- data.frame (deSolve::ode (y = init,
                                                         times = Day, 
                                                         func = SIR,
                                                         parms = Opt_par))
fitted_cumulative_incidence$observed <- Infected
fitted_cumulative_incidence$date <- dates

# plot the data
main <- paste0 ("COVID-19 fitted vs observed cumulative incidence, ", this_state)
fitted_cumulative_incidence %>%
    ggplot(aes(x = date)) + geom_line(aes(y = I), colour = "red") + 
    geom_point(aes(y = observed), colour = "orange") + 
    labs(y = "Cumulative incidence", title = main,
         subtitle = "(red=fitted incidence from SIR model, orange=observed incidence)")

R0 <- Opt_par [names (Opt_par) == "beta"] / Opt_par [names (Opt_par) == "gamma"]
message ("Basic reproductive rate = ", formatC (R0, format = "f", digits = 2))
```

The preceding code gives an estimate for the reproductive rate of 
`r formatC (R0, format = "f", digits = 2)`, compared, for example, with Tim's
estimate of around 2.0 for the initial cases from Hubei Province, China, the
origin of the current outbreak. 

## prediction

Tim's code to use the model derived above to generate predicted values follows:

```{r prediction}
t <- 1:70
# get the fitted values from our SIR model
fitted_cumulative_incidence <- data.frame(deSolve::ode(y = init, times = t, 
                                                       func = SIR, parms = Opt_par))
fitted_cumulative_incidence$date <- ymd (sir_start_date) + days (t - 1)
fitted_cumulative_incidence$observed <- c (Infected, rep (NA, nrow (fitted_cumulative_incidence) - length (Infected)))

sir <- pivot_longer (fitted_cumulative_incidence, cols = c (I, S, R)) %>%
    rename (type = name)
types <- c ("Infectious", "Susceptible", "Recovered")
sir$type <- types [match (sir$type, c ("I", "S", "R"))]
ggplot (sir, aes (x = date, y = value, colour = type)) +
    geom_line () +
    geom_point (aes (y = observed), colour = "orange") +
    scale_y_log10 () +
    labs (y = "Person", title = main)
```

```{r}
dmax <- fitted_cumulative_incidence$date [which.max (fitted_cumulative_incidence$I)]
dmax
popexp <- (N - min (fitted_cumulative_incidence$S)) / N
```
That model predicts a peak date of `r dmax`, and a resultant exposure of 
`r round (100 * popexp)`% of the population.


## Reproduction Number

The following code estimates changes in reproductive rate through time,
presuming reproductive rates themselves may vary on a case-to-case basis, and
so are drawn from an underlying generative distribution, parameterised in the
following code.

```{r changes-in-R}
confirmed_cases <- Infected
config <- make_config(list(mean_si = 6.5, std_mean_si = 2,
                      min_mean_si = 1, max_mean_si = 8.4,
                      std_si = 3.4, std_std_si = 1,
                      min_std_si = 0.5, max_std_si = 4))
res_parametric_si <- estimate_R(confirmed_cases, method = "parametric_si",
                                config = config)
res_parametric_si$dates <- dates
plot(res_parametric_si, "R") +
    scale_y_log10 ()
```

Those values are results ought not be taken as accurate at present, and
importantly use fixed estimates for mean and standard deviation of the serial
interval (SI), which is the time between the onset of symptoms in any one case,
and the onset of symptoms in secondary cases caused by that first infection.
Mean values of SI are assumed to be 6.5 days, as assumed in the latest report
from [Imperial College
London](https://www.imperial.ac.uk/mrc-global-infectious-disease-analysis/news--wuhan-coronavirus/),
and less than Tim's initial estimate of 7.5 days. These results reveal that the
rate of viral reproduction has already manifest a dramatic decrease.

The same procedure can be applied to all states of Germany, to estimate current
instantaneous reproductive rates. Note that final values are highly sensitive
to the estimated value of SI = 6.5 days. The following calculates these values
and sorts the results by increasing reproductive rate.

```{r chnages-in-R2}
window_span <- 2
tstart <- 2:(ncol (x) - window_span - 1) # -1 for 1st column of states
tend <- tstart + window_span
config <- make_config(list(mean_si = 6.5, std_mean_si = 2,
                      min_mean_si = 1, max_mean_si = 8.4,
                      std_si = 3.4, std_std_si = 1,
                      min_std_si = 0.5, max_std_si = 4,
                      t_start = tstart, t_end = tend))
rvals <- apply (x [, 2:ncol (x)], 1, function (i) {
                    res <- estimate_R(i, method = "parametric_si",
                                      config = config)
                    as.numeric (tail (res$R["Mean(R)"], 1))
                                })
data.frame (state = x$state,
            R = rvals,
            stringsAsFactors = FALSE) %>%
    arrange (R) %>%
    knitr::kable (digits = c (NA, 2))
```


